<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>LX 埋点SDK 示例</title>

    <!-- CDN JavaScript 库用于测试资源加载 -->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      .demo-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      button {
        background: #007cba;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background: #005a87;
      }
      .console {
        background: #f5f5f5;
        border: 1px solid #ccc;
        padding: 10px;
        margin: 10px 0;
        border-radius: 3px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>LX 埋点SDK 示例</h1>

    <div class="demo-section">
      <h2>基础功能演示</h2>
      <button onclick="trackPageView()">页面浏览埋点</button>
      <button onclick="trackButtonClick()">按钮点击埋点</button>
      <button onclick="trackCustomEvent()">自定义事件埋点</button>
      <button onclick="triggerError()">触发JS错误</button>
      <button onclick="makeApiRequest()">发起API请求</button>
      <button onclick="loadImage()">加载图片资源</button>
    </div>

    <div class="demo-section">
      <h2>控制台输出</h2>
      <div
        id="console"
        class="console"
      >
        等待事件...
      </div>
      <button onclick="clearConsole()">清空控制台</button>
      <button onclick="flushEvents()">立即上报事件</button>
    </div>

    <!-- 引入构建后的SDK -->
    <script src="./dist/index.umd.js"></script>
    <script>
      // 创建埋点实例
      const tracker = new LX.Tracker({
        endpoint: 'https://httpbin.org/post', // 使用httpbin作为测试接口
        batchSize: 3, // 增加批量大小，减少上报频率
        flushInterval: 30000, // 增加上报间隔到30秒
        enableConsole: true,
        userId: 'demo-user-123',
        sessionId: 'demo-session-456',
        extra: {
          appVersion: '1.0.0',
          platform: 'web-demo',
        },
      });

      // 安装插件
      tracker
        .use(new LX.JSErrorPlugin())
        .use(new LX.APIPlugin())
        .use(new LX.ResourcePlugin());

      // 重写console方法以显示在页面上
      const consoleDiv = document.getElementById('console');
      const originalLog = console.log;
      const originalGroup = console.group;
      const originalGroupEnd = console.groupEnd;
      const originalError = console.error;
      const originalWarn = console.warn;

      let groupLevel = 0;

      function addToConsole(type, args) {
        const indent = '  '.repeat(groupLevel);
        const prefix = type === 'error' ? '❌ ' : type === 'warn' ? '⚠️ ' : '';
        consoleDiv.textContent += indent + prefix + args.join(' ') + '\n';
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
      }

      console.log = function (...args) {
        originalLog.apply(console, args);
        addToConsole('log', args);
      };

      console.group = function (...args) {
        originalGroup.apply(console, args);
        if (args.length > 0) {
          addToConsole('group', args);
        }
        groupLevel++;
      };

      console.groupEnd = function () {
        originalGroupEnd.apply(console);
        groupLevel = Math.max(0, groupLevel - 1);
      };

      console.error = function (...args) {
        originalError.apply(console, args);
        addToConsole('error', args);
      };

      console.warn = function (...args) {
        originalWarn.apply(console, args);
        addToConsole('warn', args);
      };

      // 演示函数
      function trackPageView() {
        tracker.track('page-view', {
          page: '/demo',
          title: '演示页面',
          referrer: document.referrer,
        });
      }

      function trackButtonClick() {
        tracker.track('button-click', {
          buttonId: 'demo-btn',
          buttonText: '演示按钮',
          timestamp: Date.now(),
        });
      }

      function trackCustomEvent() {
        tracker.track('custom-event', {
          eventName: '自定义事件',
          customData: {
            level: 'info',
            category: 'user-interaction',
          },
        });
      }

      function triggerError() {
        // 故意触发一个错误
        setTimeout(() => {
          throw new Error('这是一个演示错误');
        }, 100);
      }

      function makeApiRequest() {
        fetch('https://httpbin.org/json')
          .then((response) => response.json())
          .then((data) => console.log('API请求成功:', data))
          .catch((error) => console.error('API请求失败:', error));
      }

      function loadImage() {
        const img = new Image();
        img.onload = () => console.log('图片加载成功');
        img.onerror = () => console.log('图片加载失败');
        img.src = 'https://httpbin.org/image/png?random=' + Math.random();
      }

      function clearConsole() {
        consoleDiv.textContent = '';
      }

      function flushEvents() {
        tracker.flush();
        console.log('已手动触发事件上报');
      }

      // 页面加载完成后自动记录页面浏览
      window.addEventListener('load', () => {
        trackPageView();
        console.log('LX 埋点SDK 已初始化完成');
      });

      // 页面卸载时清理
      window.addEventListener('beforeunload', () => {
        tracker.destroy();
      });
    </script>
  </body>
</html>
